---
name: Deploy to Production (SSH)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  deploy-ssh:
    name: Deploy (SSH) on tag push
    runs-on: ubuntu-latest
    # Do not expose secrets at the job level to satisfy static validation
    # (some event contexts like PRs from forks can't access secrets). Instead,
    # reference secrets only in the specific steps that require them.
    # Note: static analyzers may still warn about `secrets.*` expansion in
    # specific step inputs. This workflow uses `secrets` only when the job
    # executes on tag pushes or manual workflow dispatches, as constrained by
    # the job-level `if:` condition.
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node dependencies & Build
        run: |
          npm ci
          npm run build
          # bundle static output
          VERSION="${{ steps.version.outputs.VERSION }}"
          tar -czf nuxt_output_${VERSION}.tar.gz .output || true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Package Python API
        run: |
          python -m pip install --upgrade pip
          VERSION="${{ steps.version.outputs.VERSION }}"
          python -m pip install --upgrade \
            -r python_api/requirements.txt || true
          tar -czf python_api_${VERSION}.tar.gz python_api || true

      - name: Prepare deploy artifacts
        run: |
          mkdir -p deploy_artifacts
          VERSION="${{ steps.version.outputs.VERSION }}"
          mv nuxt_output_${VERSION}.tar.gz \
            deploy_artifacts/nuxt_output.tar.gz || true
          mv python_api_${VERSION}.tar.gz \
            deploy_artifacts/python_api.tar.gz || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deploy_artifacts
          path: deploy_artifacts/
