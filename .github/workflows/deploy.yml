name: Deploy to Production (SSH)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  deploy-ssh:
    name: Deploy (SSH) on tag push
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node dependencies & Build
        run: |
          npm ci
          npm run build
          # bundle static output
          tar -czf nuxt_output_${{ steps.version.outputs.VERSION }}.tar.gz .output || true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Package Python API
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade -r python_api/requirements.txt || true
          tar -czf python_api_${{ steps.version.outputs.VERSION }}.tar.gz python_api || true

      - name: Prepare deploy artifacts
        run: |
          mkdir -p deploy_artifacts
          mv nuxt_output_${{ steps.version.outputs.VERSION }}.tar.gz deploy_artifacts/nuxt_output.tar.gz || true
          mv python_api_${{ steps.version.outputs.VERSION }}.tar.gz deploy_artifacts/python_api.tar.gz || true

      - name: Add SSH key to agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: Upload artifacts to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          source: 'deploy_artifacts/*'
          target: ${{ secrets.DEPLOY_PATH || '/var/www/matlab-mobile-dataset' }}

      - name: 'Remote deploy: extract artifacts, venv, install deps, restart'
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT || '22' }}
          script: |
            set -euo pipefail
            DEPLOY_PATH=${{ secrets.DEPLOY_PATH || '/var/www/matlab-mobile-dataset' }}
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # Extract Python API
            if [ -f python_api.tar.gz ]; then
              tar -xzf python_api.tar.gz -C ./ || true
            fi

            # Create and activate venv, install requirements
            if [ ! -d ./venv ]; then
              python3 -m venv ./venv || true
            fi
            if [ -f ./python_api/requirements.txt ]; then
              . ./venv/bin/activate || true
              ./venv/bin/pip install --upgrade pip || true
              ./venv/bin/pip install -r ./python_api/requirements.txt || true
              deactivate || true
            fi

            # Extract Nuxt output
            if [ -f nuxt_output.tar.gz ]; then
              tar -xzf nuxt_output.tar.gz -C ./ || true
            fi

            # Install node modules (production) if package.json exists in root
            if [ -f ./package.json ]; then
              if command -v npm >/dev/null 2>&1; then
                npm ci --omit=dev || true
              fi
            fi

            # Ensure ownership
            if id -u www-data >/dev/null 2>&1; then
              chown -R www-data:www-data "$DEPLOY_PATH" || true
            fi

            # Restart systemd services (systemd unit names provided in infrastructure/systemd/)
            if command -v systemctl >/dev/null 2>&1; then
              systemctl --no-block daemon-reload || true
              systemctl --no-block restart python-api.service || true
              systemctl --no-block restart nuxt-app.service || true
            fi
