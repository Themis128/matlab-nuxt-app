name: Render Deployment Simulation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  simulate-render-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      NODE_ENV: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            python_api/__pycache__
          key: ${{ runner.os }}-pip-${{ hashFiles('python_api/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Verify Sentry token is present
        run: |
          if [ -z "$SENTRY_AUTH_TOKEN" ]; then
            echo "‚ùå SENTRY_AUTH_TOKEN is not set in environment"
            exit 1
          else
            echo "‚úÖ SENTRY_AUTH_TOKEN is present"
          fi

      - name: Install frontend dependencies
        run: npm ci

      - name: Install backend dependencies
        working-directory: python_api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build frontend
        run: npm run build

      - name: Start Python API server
        working-directory: python_api
        run: |
          python api.py &
          echo $! > api_pid.txt
          # Wait for API to start
          timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done' || (echo "API failed to start" && exit 1)

      - name: Test API endpoints
        working-directory: python_api
        run: |
          python test_api.py
          # Store exit code
          echo $? > test_exit_code.txt

      - name: Check test results
        working-directory: python_api
        run: |
          TEST_CODE=$(cat test_exit_code.txt)
          if [ $TEST_CODE -ne 0 ]; then
            echo "‚ùå API tests failed"
            cat test_api.py  # Show test output if available
            exit 1
          else
            echo "‚úÖ API tests passed"
          fi

      - name: Start frontend preview server
        run: |
          npm run preview &
          echo $! > frontend_pid.txt
          # Wait for frontend to start
          timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 2; done' || (echo "Frontend failed to start" && exit 1)

      - name: Test frontend health
        run: |
          # Basic health check for frontend
          curl -f http://localhost:3000 || (echo "Frontend health check failed" && exit 1)
          echo "‚úÖ Frontend is accessible"

      - name: Run deployment verification script
        working-directory: python_api
        run: |
          if [ -f "verify_production_deployment.py" ]; then
            python verify_production_deployment.py
          else
            echo "‚ö†Ô∏è  Production verification script not found, skipping"
          fi

      - name: Cleanup processes
        if: always()
        run: |
          # Kill background processes
          if [ -f "python_api/api_pid.txt" ]; then
            kill $(cat python_api/api_pid.txt) 2>/dev/null || true
          fi
          if [ -f "frontend_pid.txt" ]; then
            kill $(cat frontend_pid.txt) 2>/dev/null || true
          fi
          # Kill any remaining processes on the ports
          pkill -f "python api.py" || true
          pkill -f "npm run preview" || true

      - name: Deployment simulation summary
        if: success()
        run: |
          echo "üéâ Render deployment simulation successful!"
          echo ""
          echo "‚úÖ Frontend built and served on port 3000"
          echo "‚úÖ Backend API running and tested on port 8000"
          echo "‚úÖ All API endpoints responding correctly"
          echo "‚úÖ Cross-service communication configured"
          echo ""
          echo "üìä Services deployed:"
          echo "  - matlab-nuxt-frontend (Node.js)"
          echo "  - matlab-python-api (Python/FastAPI)"
          echo ""
          echo "üåê Service URLs (simulated):"
          echo "  - Frontend: https://matlab-nuxt-frontend.onrender.com"
          echo "  - API: https://matlab-python-api.onrender.com"

      - name: Deployment simulation failed
        if: failure()
        run: |
          echo "‚ùå Render deployment simulation failed!"
          echo ""
          echo "Possible issues:"
          echo "  - API server failed to start"
          echo "  - Frontend build failed"
          echo "  - API endpoint tests failed"
          echo "  - Port conflicts or resource issues"
          echo ""
          echo "Check the logs above for detailed error information."
