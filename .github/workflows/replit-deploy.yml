name: Deploy to Replit

on:
  push:
    branches: [master, main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "mobiles-dataset-docs/**"
      - "tests/**"
      - "screenshots/**"
  workflow_dispatch:

env:
  REPLIT_API_TOKEN: ${{ secrets.REPLIT_API_TOKEN }}
  REPLIT_APP_ID: ${{ secrets.REPLIT_APP_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Replit secrets
        run: |
          if [ -z "${{ secrets.REPLIT_API_TOKEN }}" ] || [ -z "${{ secrets.REPLIT_APP_ID }}" ]; then
            echo "::warning::REPLIT_API_TOKEN and REPLIT_APP_ID secrets are not configured"
            echo "::warning::Skipping Replit deployment"
            echo "SKIP_DEPLOY=true" >> $GITHUB_ENV
          else
            echo "SKIP_DEPLOY=false" >> $GITHUB_ENV
          fi
      - uses: actions/setup-node@v4
        if: env.SKIP_DEPLOY != 'true'
        with:
          node-version: "20"
          cache: 'npm'

      - name: Clean up npm modules and lock file
        if: env.SKIP_DEPLOY != 'true'
        run: rm -rf node_modules package-lock.json

      - name: Install dependencies
        if: env.SKIP_DEPLOY != 'true'
        run: npm install

      - name: Build application
        if: env.SKIP_DEPLOY != 'true'
        run: npm run build
        env:
          NODE_ENV: production

      - name: Install Replit CLI
        if: env.SKIP_DEPLOY != 'true'
        run: npm install -g @replit/cli

      - name: Authenticate with Replit
        if: env.SKIP_DEPLOY != 'true'
        run: echo "${{ env.REPLIT_API_TOKEN }}" | replit auth login --stdin

      - name: Deploy to Replit
        if: env.SKIP_DEPLOY != 'true'
        run: |
          echo "Deploying to Replit app: ${{ env.REPLIT_APP_ID }}"
          replit deploy --app "${{ env.REPLIT_APP_ID }}" || {
            echo "::error::Replit deployment failed"
            exit 1
          }
          echo "âœ… Deployment to Replit successful"

      - name: Summary
        if: always()
        run: |
          echo "## Replit Deployment Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.SKIP_DEPLOY }}" = "true" ]; then
            echo "- âš ï¸ Deployment skipped (secrets not configured)" >> $GITHUB_STEP_SUMMARY
            echo "- â„¹ï¸ Configure REPLIT_API_TOKEN and REPLIT_APP_ID secrets to enable deployment" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "- âœ… Application built successfully" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Deployed to Replit app: ${{ env.REPLIT_APP_ID }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš€ Deployment complete" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
