name: Assign Reviewers Based on Changed Files
on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Request reviewers based on paths
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const files = await github.paginate(github.rest.pulls.listFiles, { owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber });
            const changedFiles = files.map(f => f.filename);

            // Load reviewer mapping from `.github/reviewer-map.json` in the repo
            let mappingJson = null;
            try {
              const contentResp = await github.rest.repos.getContent({ owner: context.repo.owner, repo: context.repo.repo, path: '.github/reviewer-map.json' });
              const buff = Buffer.from(contentResp.data.content, 'base64');
              mappingJson = JSON.parse(buff.toString());
            } catch (err) {
              core.info('No reviewer map found; falling back to inline defaults.');
            }

            const pathReviewerMap = mappingJson && mappingJson.mappings ? mappingJson.mappings : [
              { path: 'python_api/', reviewers: ['Themis128'] },
              { path: 'app/', reviewers: ['Themis128'] },
              { path: 'components/', reviewers: ['Themis128'] },
              { path: 'docs/', reviewers: ['Themis128'] },
              { path: 'scripts/', reviewers: ['Themis128'] }
            ];

            const requested = new Set();
            pathReviewerMap.forEach(mapping => {
              if (changedFiles.some(f => f.startsWith(mapping.path))) {
                mapping.reviewers.forEach(r => requested.add(r));
              }
            });

            const reviewers = Array.from(requested);
            if (reviewers.length > 0) {
              await github.rest.pulls.requestReviewers({ owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber, reviewers });
            }
