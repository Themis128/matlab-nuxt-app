---
name: Replit Deployment Validation
on:
  push:
    branches: [master, main]
    paths:
      - '.replit'
      - 'scripts/deploy-production.sh'
      - 'start.sh'
      - 'package.json'
      - 'nuxt.config.ts'
      - 'python_api/**'
  pull_request:
    branches: [master, main]
    paths:
      - '.replit'
      - 'scripts/deploy-production.sh'
      - 'start.sh'
      - 'package.json'
      - 'nuxt.config.ts'
      - 'python_api/**'
  workflow_dispatch:

jobs:
  validate-replit-config:
    name: Validate Replit Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check required Replit files exist
        run: |
          echo "Checking required Replit configuration files..."
          test -f ".replit" || \
            (echo "âŒ .replit file missing" && exit 1)
          test -f "package.json" || \
            (echo "âŒ package.json file missing" && exit 1)
          test -f "nuxt.config.ts" || \
            (echo "âŒ nuxt.config.ts file missing" && exit 1)
          test -f "scripts/deploy-production.sh" || \
            (echo "âŒ deploy-production.sh missing" && exit 1)
          test -d "python_api" || \
            (echo "âŒ python_api directory missing" && exit 1)
          test -f "python_api/api.py" || \
            (echo "âŒ python_api/api.py missing" && exit 1)
          test -f "python_api/requirements.txt" || \
            (echo "âŒ requirements.txt missing" && exit 1)
          echo "âœ… All required files exist"
      - name: Validate .replit configuration
        run: |
          echo "Validating .replit configuration..."
          grep -q 'language = "nodejs"' .replit || \
            (echo "âŒ Language not set to nodejs" && exit 1)
          grep -q 'run = "bash scripts/deploy-production.sh"' \
            .replit || \
            (echo "âŒ Run command incorrect" && exit 1)
          grep -q 'NODE_ENV = "production"' .replit || \
            (echo "âŒ NODE_ENV not set to production" && exit 1)
          grep -q 'HOST = "0.0.0.0"' .replit || \
            (echo "âŒ HOST not set correctly" && exit 1)
          grep -q 'PORT = "3000"' .replit || \
            (echo "âŒ PORT not set to 3000" && exit 1)
          echo "âœ… .replit configuration is valid"
      - name: Validate deploy-production.sh script
        run: |
          echo "Validating deploy-production.sh script..."
          SCRIPT="scripts/deploy-production.sh"
          grep -q "NODE_ENV=production" $SCRIPT || \
            (echo "âŒ Script missing NODE_ENV=production" && exit 1)
          grep -q "HOST=0.0.0.0" $SCRIPT || \
            (echo "âŒ Script missing HOST=0.0.0.0" && exit 1)
          grep -q "PORT=3000" $SCRIPT || \
            (echo "âŒ Script missing PORT=3000" && exit 1)
          grep -q "npm run build" $SCRIPT || \
            (echo "âŒ Script missing npm run build" && exit 1)
          grep -q "npm run preview" $SCRIPT || \
            (echo "âŒ Script missing npm run preview" && exit 1)
          grep -q "python api.py" $SCRIPT || \
            (echo "âŒ Script missing python api.py" && exit 1)
          echo "âœ… deploy-production.sh script is valid"
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Check Node.js dependencies
        run: |
          echo "Checking Node.js dependencies..."
          npm ci
          echo "âœ… Node.js dependencies installed"
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Check Python API dependencies
        run: |
          echo "Checking Python API dependencies..."
          cd python_api
          pip install -r requirements.txt
          python -c "import api; \
            print('âœ… Python API module loads')"
          cd ..
          echo "âœ… Python API dependencies installed"
      - name: Validate package.json scripts
        run: |
          echo "Validating package.json scripts..."
          npm run --silent build --dry-run 2>/dev/null || \
            echo "Note: build script validation skipped"
          echo "âœ… Package.json scripts are present"
      - name: Summary
        run: |
          SUM="$GITHUB_STEP_SUMMARY"
          echo "## Replit Deployment Validation" >> $SUM
          echo "- âœ… Required files exist" >> $SUM
          echo "- âœ… .replit configuration is valid" >> $SUM
          echo "- âœ… deploy-production.sh is valid" >> $SUM
          echo "- âœ… Node.js dependencies install" >> $SUM
          echo "- âœ… Python API dependencies install" >> $SUM
          echo "- âœ… Package.json scripts configured" >> $SUM
          echo "" >> $SUM
          echo "### Ready for Replit Deployment ðŸš€" >> $SUM
          echo "All files and configurations ready." >> $SUM
