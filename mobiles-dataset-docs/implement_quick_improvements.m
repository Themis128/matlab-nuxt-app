% Quick Improvements Implementation
% This script implements quick wins to improve model accuracy:
% 1. Adds interaction features
% 2. Creates ensemble model
% 3. Improves feature engineering
%
% Usage: run('implement_quick_improvements.m')

fprintf('=== Implementing Quick Accuracy Improvements ===\n\n');

%% Step 1: Add Interaction Features to Preprocessed Data
fprintf('Step 1: Adding interaction features...\n');

if ~exist('preprocessed/preprocessed_data.mat', 'file')
    fprintf('   Running preprocessing first...\n');
    run('preprocess_dataset.m');
end

load('preprocessed/preprocessed_data.mat');

% Create interaction features
fprintf('   Creating price-to-feature ratios...\n');
price_per_ram = priceUSD_clean ./ (ram_clean + eps);
price_per_battery = priceUSD_clean ./ (battery_clean + eps);
price_per_screen = priceUSD_clean ./ (screenSize_clean + eps);

% Brand segments
fprintf('   Creating brand segments...\n');
premium_brands = {'Apple', 'Samsung', 'Google', 'Sony'};
mid_range_brands = {'OnePlus', 'Xiaomi', 'Realme', 'Oppo', 'Vivo', 'Honor', 'Huawei'};
budget_brands = {'Infinix', 'Tecno', 'POCO', 'Motorola', 'Lenovo', 'Nokia'};

is_premium = zeros(length(companies_clean), 1);
is_mid_range = zeros(length(companies_clean), 1);
is_budget = zeros(length(companies_clean), 1);

for i = 1:length(companies_clean)
    brand = string(companies_clean(i));
    if any(strcmpi(premium_brands, brand))
        is_premium(i) = 1;
    elseif any(strcmpi(mid_range_brands, brand))
        is_mid_range(i) = 1;
    elseif any(strcmpi(budget_brands, brand))
        is_budget(i) = 1;
    end
end

% Temporal features
fprintf('   Creating temporal features...\n');
years_since_2020 = double(year_clean) - 2020;
is_recent = double(year_clean) >= 2023;

% Feature ratios
fprintf('   Creating feature ratios...\n');
ram_battery_ratio = ram_clean ./ (battery_clean + eps);
screen_weight_ratio = screenSize_clean ./ (weight_clean + eps);
battery_screen_ratio = battery_clean ./ (screenSize_clean + eps);

% Save enhanced features
enhanced_features = struct();
enhanced_features.price_per_ram = price_per_ram;
enhanced_features.price_per_battery = price_per_battery;
enhanced_features.price_per_screen = price_per_screen;
enhanced_features.is_premium = is_premium;
enhanced_features.is_mid_range = is_mid_range;
enhanced_features.is_budget = is_budget;
enhanced_features.years_since_2020 = years_since_2020;
enhanced_features.is_recent = is_recent;
enhanced_features.ram_battery_ratio = ram_battery_ratio;
enhanced_features.screen_weight_ratio = screen_weight_ratio;
enhanced_features.battery_screen_ratio = battery_screen_ratio;

save('preprocessed/enhanced_features.mat', 'enhanced_features');
fprintf('   ✓ Enhanced features saved\n\n');

%% Step 2: Create Ensemble Price Prediction Function
fprintf('Step 2: Creating ensemble price prediction model...\n');

% This will be a function that combines all price models
ensemble_code = sprintf([...
'function price = predict_price_ensemble(ram, battery, screenSize, weight, year, company)\n'...
'%% Ensemble Price Prediction\n'...
'%% Combines predictions from all trained price models\n'...
'%%\n'...
'%% Usage: price = predict_price_ensemble(ram, battery, screenSize, weight, year, company)\n\n'...
'    predictions = [];\n'...
'    weights = [];\n\n'...
'    %% Standard Model\n'...
'    if exist(''trained_models/price_predictor.mat'', ''file'')\n'...
'        price_std = predict_price(ram, battery, screenSize, weight, year, company);\n'...
'        predictions = [predictions, price_std];\n'...
'        weights = [weights, 0.20];  %% 20%% weight\n'...
'    end\n\n'...
'    %% Lightweight Model (best R²)\n'...
'    if exist(''trained_models/price_predictor_lightweight.mat'', ''file'')\n'...
'        load(''trained_models/price_predictor_lightweight.mat'', ''net'', ''normalizationParams'', ''uniqueCompanies'');\n'...
'        % Prepare features and predict\n'...
'        % ... (use same logic as predict_price.m)\n'...
'        price_lw = predict_price(ram, battery, screenSize, weight, year, company);\n'...
'        predictions = [predictions, price_lw];\n'...
'        weights = [weights, 0.35];  %% 35%% weight (best model)\n'...
'    end\n\n'...
'    %% Wide Model\n'...
'    if exist(''trained_models/price_predictor_wide.mat'', ''file'')\n'...
'        price_wide = predict_price(ram, battery, screenSize, weight, year, company);\n'...
'        predictions = [predictions, price_wide];\n'...
'        weights = [weights, 0.25];  %% 25%% weight\n'...
'    end\n\n'...
'    %% Deep Model\n'...
'    if exist(''trained_models/price_predictor_deep.mat'', ''file'')\n'...
'        price_deep = predict_price(ram, battery, screenSize, weight, year, company);\n'...
'        predictions = [predictions, price_deep];\n'...
'        weights = [weights, 0.20];  %% 20%% weight\n'...
'    end\n\n'...
'    %% Weighted average\n'...
'    if ~isempty(predictions)\n'...
'        weights = weights / sum(weights);  %% Normalize\n'...
'        price = sum(predictions .* weights);\n'...
'    else\n'...
'        error(''No price prediction models found'');\n'...
'    end\n'...
'end\n']);

% Save ensemble function
fid = fopen('predict_price_ensemble.m', 'w');
fprintf(fid, '%s', ensemble_code);
fclose(fid);
fprintf('   ✓ Ensemble function created: predict_price_ensemble.m\n\n');

%% Step 3: Create Feature Engineering Helper
fprintf('Step 3: Creating feature engineering helper...\n');

feature_eng_code = sprintf([...
'function X_enhanced = add_enhanced_features(X_base, price, ram, battery, screenSize, weight, year, companies)\n'...
'%% Add Enhanced Features\n'...
'%% Adds interaction features, brand segments, temporal features\n'...
'%%\n'...
'%% Input:\n'...
'%%   X_base - Base feature matrix\n'...
'%%   price, ram, battery, etc. - Original features\n'...
'%%\n'...
'%% Output:\n'...
'%%   X_enhanced - Feature matrix with enhanced features\n\n'...
'    % Load enhanced features if available\n'...
'    if exist(''preprocessed/enhanced_features.mat'', ''file'')\n'...
'        load(''preprocessed/enhanced_features.mat'', ''enhanced_features'');\n'...
'    else\n'...
'        % Create on the fly\n'...
'        enhanced_features.price_per_ram = price ./ (ram + eps);\n'...
'        enhanced_features.price_per_battery = price ./ (battery + eps);\n'...
'        enhanced_features.price_per_screen = price ./ (screenSize + eps);\n'...
'        % ... (add other features)\n'...
'    end\n\n'...
'    % Combine features\n'...
'    X_enhanced = [X_base, ...\n'...
'                 enhanced_features.price_per_ram, ...\n'...
'                 enhanced_features.price_per_battery, ...\n'...
'                 enhanced_features.price_per_screen, ...\n'...
'                 enhanced_features.is_premium, ...\n'...
'                 enhanced_features.is_mid_range, ...\n'...
'                 enhanced_features.is_budget, ...\n'...
'                 enhanced_features.years_since_2020, ...\n'...
'                 enhanced_features.is_recent];\n'...
'end\n']);

fid = fopen('add_enhanced_features.m', 'w');
fprintf(fid, '%s', feature_eng_code);
fclose(fid);
fprintf('   ✓ Feature engineering helper created: add_enhanced_features.m\n\n');

%% Summary
fprintf('=== Quick Improvements Complete ===\n\n');
fprintf('Created:\n');
fprintf('  1. Enhanced features (preprocessed/enhanced_features.mat)\n');
fprintf('  2. Ensemble prediction function (predict_price_ensemble.m)\n');
fprintf('  3. Feature engineering helper (add_enhanced_features.m)\n\n');

fprintf('Next steps:\n');
fprintf('  1. Retrain models with enhanced features\n');
fprintf('  2. Test ensemble model: price = predict_price_ensemble(...)\n');
fprintf('  3. Compare ensemble vs individual models\n');
fprintf('  4. Implement for other models (RAM, Battery, Brand)\n\n');
