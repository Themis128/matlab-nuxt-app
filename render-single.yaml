# Single-Service Render Deployment Configuration
# This deploys both Nuxt frontend and Python API in a single service
#
# Use this if you want a simpler deployment with just one service.
# For production, we recommend using render.yaml (two services) instead.
#
# To use this file:
# 1. Rename it to render.yaml (backup the original first)
# 2. Deploy using Render Blueprint
# 3. Access your app at the service URL (shows Nuxt frontend)

services:
  - type: web
    name: matlab-nuxt-app
    runtime: node

    # Build both Node and Python components
    buildCommand: |
      echo "üì¶ Installing Node.js dependencies..."
      npm ci

      echo "üèóÔ∏è  Building Nuxt application..."
      npm run build

      echo "üêç Installing Python dependencies..."
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt

      echo "ü§ñ Training ML models..."
      cd python_api && python train_models_sklearn.py
      cd .. && python retrain_advanced_models.py

      echo "‚úÖ Build complete!"

    # Start both services (Python in background, Nuxt as main process)
    startCommand: |
      cd python_api && python api.py &
      sleep 5
      cd .. && npm run preview

    # Health check on Nuxt frontend
    healthCheckPath: /

    # Environment variables
    envVars:
      # Node/Nuxt configuration
      - key: NODE_ENV
        value: production
      - key: HOST
        value: 0.0.0.0
      - key: PORT
        value: '3000'

      # Python API configuration
      # Note: API runs on port 8000 internally, but frontend is exposed on port 3000
      - key: NUXT_PUBLIC_API_BASE
        value: http://localhost:8000
      - key: PYTHON_API_URL
        value: http://localhost:8000

      # Python settings
      - key: PYTHONUNBUFFERED
        value: '1'
      - key: LOG_LEVEL
        value: INFO

      # CORS (allow requests from same origin)
      - key: CORS_ORIGINS
        value: http://localhost:3000,http://127.0.0.1:3000
