"""
Unit tests for sklearn-based predictions
"""
import sys
from pathlib import Path

import numpy as np
import pytest

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from predictions_sklearn import (
    SklearnPredictor,
    predict_battery,
    predict_brand,
    predict_price,
    predict_ram,
)


class TestSklearnPredictor:
    """Test SklearnPredictor class"""

    def test_predictor_initialization(self):
        """Test that predictor initializes without errors"""
        predictor = SklearnPredictor()
        assert predictor is not None
        assert hasattr(predictor, 'models')
        assert hasattr(predictor, 'scalers')
        assert hasattr(predictor, 'metadata')

    def test_models_loaded(self):
        """Test that models are loaded from disk"""
        predictor = SklearnPredictor()
        # At least one model should be available
        assert len(predictor.models) > 0 or len(predictor.metadata) > 0

    def test_encode_company(self):
        """Test company encoding"""
        predictor = SklearnPredictor()

        # Test known company
        encoded = predictor.encode_company('Samsung', 'price_predictor')
        assert isinstance(encoded, np.ndarray)
        assert len(encoded) > 0

        # Test unknown company
        encoded_unknown = predictor.encode_company('UnknownBrand', 'price_predictor')
        assert isinstance(encoded_unknown, np.ndarray)

    def test_encode_processor(self):
        """Test processor encoding"""
        predictor = SklearnPredictor()

        # encode_processor only takes processor name, not model name
        encoded = predictor.encode_processor('Snapdragon 8 Gen 2')
        assert isinstance(encoded, np.ndarray)
        assert len(encoded) > 0
class TestPricePrediction:
    """Test price prediction functionality"""

    def test_predict_price_returns_number(self):
        """Test that predict_price returns a numeric value"""
        result = predict_price(
            ram=8,
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        assert isinstance(result, (int, float))
        assert result > 0

    def test_predict_price_reasonable_range(self):
        """Test that price predictions are in reasonable range"""
        result = predict_price(
            ram=8,
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        # Reasonable price range for modern smartphones
        assert 100 <= result <= 5000

    def test_predict_price_premium_brand(self):
        """Test that premium brands get higher predicted prices"""
        samsung_price = predict_price(
            ram=8, battery=5000, screen_size=6.5,
            weight=200, year=2024, company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )

        budget_price = predict_price(
            ram=8, battery=5000, screen_size=6.5,
            weight=200, year=2024, company='Xiaomi',
            processor='Snapdragon 8 Gen 2'
        )

        # Samsung should generally be priced higher or similar
        # (allowing for model variations)
        assert samsung_price > 0 and budget_price > 0

    def test_predict_price_with_invalid_inputs(self):
        """Test price prediction handles edge cases"""
        # Very low RAM
        result = predict_price(
            ram=1, battery=3000, screen_size=5.0,
            weight=150, year=2020, company='Unknown',
            processor='Unknown'
        )
        assert result > 0

    @pytest.mark.parametrize("ram,battery,expected_min", [
        (4, 3000, 100),
        (8, 5000, 200),
        (12, 6000, 300),
    ])
    def test_predict_price_scales_with_specs(self, ram, battery, expected_min):
        """Test that price scales with specifications"""
        result = predict_price(
            ram=ram,
            battery=battery,
            screen_size=6.5,
            weight=200,
            year=2024,
            company='Samsung',
            processor='Snapdragon'
        )
        assert result >= expected_min


class TestRAMPrediction:
    """Test RAM prediction functionality"""

    def test_predict_ram_returns_number(self):
        """Test that predict_ram returns a numeric value"""
        result = predict_ram(
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        assert isinstance(result, (int, float))
        assert result > 0

    def test_predict_ram_reasonable_range(self):
        """Test that RAM predictions are in reasonable range"""
        result = predict_ram(
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        # Typical RAM range for smartphones
        assert 2 <= result <= 24

    def test_predict_ram_correlates_with_price(self):
        """Test that higher price predicts higher RAM"""
        low_price_ram = predict_ram(
            battery=4000, screen_size=6.0, weight=180,
            year=2024, price=200, company='Budget',
            processor='Basic'
        )

        high_price_ram = predict_ram(
            battery=5000, screen_size=6.5, weight=200,
            year=2024, price=1000, company='Premium',
            processor='Advanced'
        )

        assert low_price_ram > 0 and high_price_ram > 0


class TestBatteryPrediction:
    """Test battery prediction functionality"""

    def test_predict_battery_returns_number(self):
        """Test that predict_battery returns a numeric value"""
        result = predict_battery(
            ram=8,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        assert isinstance(result, (int, float))
        assert result > 0

    def test_predict_battery_reasonable_range(self):
        """Test that battery predictions are in reasonable range"""
        result = predict_battery(
            ram=8,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            company='Samsung',
            processor='Snapdragon 8 Gen 2'
        )
        # Typical battery capacity for smartphones
        assert 2000 <= result <= 8000


class TestBrandPrediction:
    """Test brand prediction functionality"""

    def test_predict_brand_returns_string(self):
        """Test that predict_brand returns a string"""
        result = predict_brand(
            ram=8,
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            processor='Snapdragon 8 Gen 2'
        )
        assert isinstance(result, str)
        assert len(result) > 0

    def test_predict_brand_known_brands(self):
        """Test that predictions are known brands"""
        result = predict_brand(
            ram=8,
            battery=5000,
            screen_size=6.5,
            weight=200,
            year=2024,
            price=500,
            processor='Snapdragon'
        )
        # Should return a recognizable brand name
        common_brands = ['Apple', 'Samsung', 'Xiaomi', 'OnePlus', 'Google', 'Other']
        # The result should be a valid brand name (any string is valid)
        assert isinstance(result, str)


class TestEdgeCases:
    """Test edge cases and error handling"""

    def test_extreme_values(self):
        """Test predictions with extreme input values"""
        # Very high specs
        price = predict_price(
            ram=24, battery=10000, screen_size=8.0,
            weight=300, year=2025, company='Premium',
            processor='Latest'
        )
        assert price > 0

    def test_very_old_year(self):
        """Test with old year"""
        price = predict_price(
            ram=4, battery=3000, screen_size=5.0,
            weight=150, year=2015, company='Old',
            processor='Old'
        )
        assert price > 0

    def test_empty_strings(self):
        """Test with empty string inputs"""
        price = predict_price(
            ram=8, battery=5000, screen_size=6.5,
            weight=200, year=2024, company='',
            processor=''
        )
        assert price > 0


if __name__ == '__main__':
    pytest.main([__file__, '-v'])
